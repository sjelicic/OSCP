using System;
using System.Collections.Generic;

namespace Watson
{
    public class VulnerabilityCollection
    {
        private const int NUMBER_OF_VULNERABILITES = 30;

        // Key: Name - Value: Vulnerability
        private readonly Dictionary<string, Vulnerability> _vulnerabilities = new Dictionary<string, Vulnerability>(NUMBER_OF_VULNERABILITES);

        private string _errors = "";

        public VulnerabilityCollection()
        {
            PopulateVulnerabilities();
        }

        public void SetAsVulnerable(string name) 
            => _vulnerabilities[name].SetAsVulnerable();


        public void AddError(string errorMessage)
            => _errors += "ERROR> " + errorMessage + Environment.NewLine;

        public void ShowResults()
        {
            int vulnerabilityCount = 0;
            foreach (var vulnerability in _vulnerabilities.Values)
            {
                if (vulnerability.IsVulnerable)
                {
                    Console.WriteLine("  [*] Appears vulnerable to {0}", vulnerability.Name);
                    Console.WriteLine("   [>] Description: {0}", vulnerability.Description);
                    Console.WriteLine("   [>] Exploit: {0}", vulnerability.Exploit);
                    Console.WriteLine("   [>] Notes: {0}", vulnerability.Notes);
                    Console.WriteLine();
                    vulnerabilityCount++;
                }
            }

            if (vulnerabilityCount != 0)
                Console.WriteLine(" [*] Finished. Found {0} vulns :)", vulnerabilityCount);
            else
                Console.WriteLine(" [*] Finished. Sorry, found 0 vulns :(");

            // Output any errors found
            Console.WriteLine(_errors);
        }

        private void PopulateVulnerabilities()
        {
            // populate a list
            var vulnList= new List<Vulnerability>(NUMBER_OF_VULNERABILITES)
            {
                new Vulnerability(name: "MS10-015",
                    description: "Windows SYSTEM Escalation via KiTrap0D.",
                    exploit: "https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/windows/local/ms10_015_kitrap0d.rb"),

                new Vulnerability(name: "MS10-073",
                    description: "Kernel-mode drivers load unspecified keyboard layers improperly, which result in arbitrary code execution in the kernel.",
                    exploit: "https://www.exploit-db.com/exploits/36327/"),

                new Vulnerability(name: "MS10-092",
                    description: "When processing task files, the Windows Task Scheduler only uses a CRC32 checksum to validate that the file has not been tampered with.Also, In a default configuration, normal users can read and write the task files that they have created.By modifying the task file and creating a CRC32 collision, an attacker can execute arbitrary commands with SYSTEM privileges.",
                    exploit: "https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/windows/local/ms10_092_schelevator.rb"),

                new Vulnerability(name: "MS11-046",
                    description: "The Ancillary Function Driver (AFD) in afd.sys does not properly validate user-mode input, which allows local users to elevate privileges.",
                    exploit: "https://www.exploit-db.com/exploits/40564/"),

                new Vulnerability(name: "MS11-080",
                    description: "An EoP exists due to a flaw in the AfdJoinLeaf function of the afd.sys driver, allowing data overwrite in kernel space.",
                    exploit: "https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/windows/local/ms11_080_afdjoinleaf.rb"),

                new Vulnerability(name: "MS12-042",
                    description: "An EoP exists due to the way the Windows User Mode Scheduler handles system requests, which can be exploited to execute arbitrary code in kernel mode.",
                    exploit: "https://www.exploit-db.com/exploits/20861/"),

                new Vulnerability(name: "MS13-005",
                    description: "Due to a problem with isolating window broadcast messages in the Windows kernel, an attacker can broadcast commands from a lower Integrity Level process to a higher Integrity Level process, thereby effecting a privilege escalation.",
                    exploit: "https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/windows/local/ms13_005_hwnd_broadcast.rb"),

                new Vulnerability(name: "MS13-053", description: "An EoP exists due to a kernel pool overflow in Win32k.",
                    exploit: "https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/windows/local/ms13_053_schlamperei.rb"),

                new Vulnerability(name: "MS13-081",
                    description: "An EoP exists in win32k.sys where under specific conditions TrackPopupMenuEx will pass a NULL pointer to the MNEndMenuState procedure.",
                    exploit: "https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/windows/local/ms13_081_track_popup_menu.rb"),

                new Vulnerability(name: "MS14-058",
                    description: "An EoP exists due to a NULL Pointer Dereference in win32k.sys, triggered through the use of TrackPopupMenu.",
                    exploit: "https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/windows/local/ms14_058_track_popup_menu.rb"),

                new Vulnerability(name: "MS15-051",
                    description: "An EoP exists due to improper object handling in the win32k.sys kernel mode driver.",
                    exploit: "https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/windows/local/ms15_051_client_copy_image.rb"),

                new Vulnerability(name: "MS15-076",
                    description: "Local DCOM DCE/RPC connections can be reflected back to a listening TCP socket allowing access to an NTLM authentication challenge for LocalSystem, which can be replayed to the local DCOM activation service to elevate privileges.",
                    exploit: "https://www.exploit-db.com/exploits/37768/"),

                new Vulnerability(name: "MS15-078",
                    description: "An EoP exists due to a pool based buffer overflow in the atmfd.dll driver when parsing a malformed font.",
                    exploit: "https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/windows/local/ms15_078_atmfd_bof.rb"),

                new Vulnerability(name: "MS16-014",
                    description: "An EoP exists when the Windows kernel improperly handles objects in memory.",
                    exploit: "https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/windows/local/ms16_014_wmi_recv_notif.rb"),

                new Vulnerability(name: "MS16-016",
                    description: "An EoP exists in the Microsoft Web Distributed Authoring and Versioning (WebDAV) client when WebDAV improperly validates input.",
                    exploit: "https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/windows/local/ms16_016_webdav.rb"),

                new Vulnerability(name: "MS16-032",
                    description: "An EoP exists due to a lack of sanitization of standard handles in Windows' Secondary Logon Service.",
                    exploit: "https://github.com/FuzzySecurity/PowerShell-Suite/blob/master/Invoke-MS16-032.ps1"),

                new Vulnerability(name: "MS16-034",
                    description: "An EoP exist when the Windows kernel-mode driver fails to properly handle objects in memory.",
                    exploit: "https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS16-034"),

                new Vulnerability(name: "MS16-039",
                    description: "An EoP exist when the Windows kernel-mode driver fails to properly handle objects in memory.",
                    exploit: "https://www.exploit-db.com/exploits/44480/",
                    notes: "Exploit is for Windows 7 x86."),

                new Vulnerability(name: "MS16-072",
                    description: "This vulnerability allows an attacker to create/modify local Administrator account through a fake Domain Controller by creating User Configuration Group Policies.",
                    exploit: "https://www.exploit-db.com/exploits/40219/",
                    notes: "Good luck with this one..."),

                new Vulnerability(name: "MS16-111",
                    description: "The NtLoadKeyEx system call allows an unprivileged user to load registry hives outside of the \\Registry\\A hidden attachment point which can be used to elevate privileges.",
                    exploit: "https://www.exploit-db.com/exploits/40429/"),

                new Vulnerability(name: "MS16-123",
                    description: "The DFS Client driver and running by default insecurely creates and deletes drive letter symbolic links in the current user context, leading to EoP.",
                    exploit: "https://www.exploit-db.com/exploits/40572/",
                    notes: "Exploit requires weaponisation."),

                new Vulnerability(name: "MS16-125",
                    description: "The fix for CVE-2016-3231 is insufficient to prevent a normal user specifying an insecure agent path leading to arbitrary DLL loading at system privileges.",
                    exploit: "https://www.exploit-db.com/exploits/40562/",
                    notes: "Exploit requires a DLL to load."),

                new Vulnerability(name: "MS16-135",
                    description: "An EoP exists when the Windows kernel-mode driver fails to properly handle objects in memory.",
                    exploit: "https://github.com/FuzzySecurity/PSKernel-Primitives/tree/master/Sample-Exploits/MS16-135"),

                new Vulnerability(name: "MS16-138",
                    description: "The VHDMP driver doesn’t safely create files related to Resilient Change Tracking leading to arbitrary file overwrites under user control, leading to EoP.",
                    exploit: "https://www.exploit-db.com/exploits/40763/",
                    notes: "Exploit requires weaponisation."),

                new Vulnerability(name: "MS17-012",
                    description: "When activating an object using the session moniker the DCOM activator doesn’t check if the current user has permission, allowing a user to start an arbitrary process in another logged on user's session.",
                    exploit: "https://www.exploit-db.com/exploits/41607/"),

                new Vulnerability(name: "MS17-017", 
                    description: "GDI Palette Objects EoP.",
                    exploit: "https://www.exploit-db.com/exploits/42432/",
                    notes: "Exploit is for Windows 7 x86 only"),

                new Vulnerability(name: "CVE-2017-0263",
                    description: "An EoP exists in Windows when the Windows kernel-mode driver fails to properly handle objects in memory.",
                    exploit: "https://www.exploit-db.com/exploits/44478/",
                    notes: "Exploit is for Windows 7 x86."),

                new Vulnerability(name: "CVE-2018-8897",
                    description: "An EoP exists when the Windows kernel fails to properly handle objects in memory.",
                    exploit: "https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/windows/local/mov_ss.rb",
                    notes: "May not work on all hypervisors."),

                new Vulnerability(name: "CVE-2018-0952",
                    description: "An EoP exists when Diagnostics Hub Standard Collector allows file creation in arbitrary locations. ",
                    exploit: "https://www.exploit-db.com/exploits/45244/"),

                new Vulnerability(name: "CVE-2018-8440",
                    description: "An EoP exists when Windows improperly handles calls to Advanced Local Procedure Call (ALPC).",
                    exploit: "https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/windows/local/alpc_taskscheduler.rb")
            };

            // use the list to populate the dictionary to prevent having to type the key (Name) out again
            foreach (var vulnerability in vulnList)
                _vulnerabilities.Add(vulnerability.Name, vulnerability);
        }


    }
}